name: Uptime Monitoring

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  uptime-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check site uptime
        id: uptime
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://www.scapatech.com/)
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          if [ $STATUS -ne 200 ]; then
            echo "::error::Site returned status $STATUS"
            exit 1
          fi

          echo "Site is up (HTTP $STATUS)"

      - name: Check for critical elements
        run: |
          # Check if page contains expected content
          CONTENT=$(curl -s https://www.scapatech.com/)

          if ! echo "$CONTENT" | grep -q "Scapa"; then
            echo "::error::Critical content not found on page"
            exit 1
          fi

          echo "Critical content check passed"

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Site Down - Uptime Check Failed`,
              body: `The uptime check failed for https://www.scapatech.com/

              **Time:** ${new Date().toISOString()}
              **Workflow:** ${context.workflow}
              **Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

              Please investigate the issue.`,
              labels: ['bug', 'urgent', 'uptime']
            })
